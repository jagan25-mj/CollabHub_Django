<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Founder Dashboard - CollabHub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', system-ui, sans-serif; }
    </style>
</head>
<body class="bg-white">
    <script src="../js/api.js"></script>
    <script src="../js/state.js"></script>
    <script src="../js/components.js"></script>
    <script src="../js/app.js"></script>
    
    <script>
        // This page is now loaded dynamically via router
        // No content here - router will inject content
        // Kept for backward compatibility with direct access
        window.location.href = '/dashboard/founder';
    </script>
</body>
</html>
        if (!window.CollabHubAPI.isAuthenticated()) window.location.href = '/app/login';
        const user = window.CollabHubAPI.getUserData();
        if (user?.role !== 'founder') window.location.href = `/app/dashboard-${user?.role || 'talent'}`;

        let founderStartups = [];
        let allApplications = [];

        // Load dashboard data
        async function loadDashboardData() {
            try {
                // Load my startups
                const startupRes = await fetch('/api/v1/startups/my/', {
                    headers: { 'Authorization': `Bearer ${window.CollabHubAPI.getAccessToken()}` }
                });
                const startupData = await startupRes.json();
                founderStartups = Array.isArray(startupData) ? startupData : (startupData.results || []);

                // Load all applications for founder's startups
                allApplications = [];
                for (const startup of founderStartups) {
                    try {
                        const appRes = await fetch(`/api/v1/collaborations/startups/${startup.id}/applications/`, {
                            headers: { 'Authorization': `Bearer ${window.CollabHubAPI.getAccessToken()}` }
                        });
                        if (appRes.ok) {
                            const appData = await appRes.json();
                            const apps = Array.isArray(appData) ? appData : (appData.results || []);
                            allApplications.push(...apps.map(app => ({ ...app, startup })));
                        }
                    } catch (e) {
                        console.log('Could not load applications for startup', startup.id);
                    }
                }

                updateStats();
                renderStartups();
                renderApplications();
            } catch (error) {
                console.error('Error loading dashboard data:', error);
            }
        }

        function updateStats() {
            // Update My Startups stat
            const statBoxes = document.querySelectorAll('.grid.md\\:grid-cols-4 > div');
            if (statBoxes[0]) {
                statBoxes[0].querySelector('.text-3xl').textContent = founderStartups.length;
            }

            // Update Applications count
            const pendingApps = allApplications.filter(a => a.status === 'pending').length;
            if (statBoxes[2]) {
                statBoxes[2].querySelector('.text-3xl').textContent = pendingApps;
            }

            // Update Team Members count (sum of all team members across startups)
            let totalTeamMembers = 0;
            founderStartups.forEach(startup => {
                totalTeamMembers += startup.team_size || 1;
            });
            if (statBoxes[3]) {
                statBoxes[3].querySelector('.text-3xl').textContent = totalTeamMembers;
            }
        }

        function renderStartups() {
            const container = document.getElementById('startups-list');
            if (!container || !founderStartups.length) {
                container.innerHTML = '<p class="text-gray-400">No startups yet. Create your first startup!</p>';
                return;
            }

            const html = founderStartups.map(startup => `
                <div class="bg-white/5 rounded-xl p-5 border border-white/10 hover:border-white/30 transition-colors cursor-pointer"
                     onclick="window.location.href='/app/startup-detail?id=${startup.id}'">
                    <div class="flex items-center justify-between mb-3">
                        <div class="w-12 h-12 bg-gradient-to-r from-sky-500 to-fuchsia-500 rounded-xl flex items-center justify-center text-white font-bold">
                            ${(startup.name?.[0] || 'S').toUpperCase()}
                        </div>
                        <span class="px-2 py-1 ${startup.status === 'active' ? 'bg-emerald-500/20 text-emerald-400' : 'bg-gray-500/20 text-gray-400'} rounded text-xs">${startup.status?.charAt(0).toUpperCase() + startup.status?.slice(1) || 'Active'}</span>
                    </div>
                    <h3 class="text-white font-semibold">${startup.name}</h3>
                    <p class="text-gray-400 text-sm">${(startup.description || 'No description').substring(0, 60)}...</p>
                    <p class="text-gray-500 text-xs mt-2">Stage: ${(startup.stage || 'idea').charAt(0).toUpperCase() + (startup.stage || 'idea').slice(1)}</p>
                </div>
            `).join('');

            container.innerHTML = html || '<p class="text-gray-400">No startups yet.</p>';
        }

        function renderApplications() {
            const container = document.getElementById('applications-list');
            const pendingApps = allApplications.filter(a => a.status === 'pending').slice(0, 5);
            
            if (!container || !pendingApps.length) {
                container.innerHTML = '<p class="text-gray-400 text-sm">No pending applications.</p>';
                return;
            }

            const html = pendingApps.map(app => {
                const applicant = app.applicant || {};
                const initials = ((applicant.first_name?.[0] || '') + (applicant.last_name?.[0] || '') || 'U').toUpperCase();
                const statusColor = app.status === 'pending' ? 'bg-yellow-500/20 text-yellow-400' : 'bg-gray-500/20 text-gray-400';
                
                return `
                    <div class="flex items-center justify-between p-4 bg-white/5 rounded-xl border border-white/10 hover:border-white/30 transition-colors">
                        <div class="flex items-center flex-1 min-w-0 cursor-pointer" onclick="viewApplicationDetails('${app.id}')">
                            <div class="w-10 h-10 bg-gradient-to-r from-sky-500 to-fuchsia-500 rounded-full flex items-center justify-center text-white font-medium mr-3 flex-shrink-0">
                                ${initials}
                            </div>
                            <div class="min-w-0">
                                <div class="text-white font-medium truncate">${applicant.first_name || applicant.username || 'Unknown'}</div>
                                <div class="text-gray-500 text-sm truncate">${app.startup?.name || 'Unknown Opportunity'}</div>
                            </div>
                        </div>
                        <div class="flex space-x-2 ml-3 flex-shrink-0">
                            <button onclick="updateApplicationStatus('${app.id}', 'accepted')"
                                class="px-3 py-1 bg-emerald-500/20 text-emerald-400 rounded text-sm hover:bg-emerald-500/30 transition-colors">✓</button>
                            <button onclick="updateApplicationStatus('${app.id}', 'rejected')"
                                class="px-3 py-1 bg-red-500/20 text-red-400 rounded text-sm hover:bg-red-500/30 transition-colors">✕</button>
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = html;
        }

        async function updateApplicationStatus(appId, action) {
            const token = window.CollabHubAPI.getAccessToken();
            try {
                const response = await fetch(`/api/v1/collaborations/applications/${appId}/status/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ action })
                });

                if (response.ok) {
                    showToast(`Application ${action}`, 'success');
                    loadDashboardData(); // Refresh the list
                } else {
                    showToast(`Failed to ${action} application`, 'error');
                }
            } catch (error) {
                console.error('Error updating application:', error);
                showToast('Error updating application', 'error');
            }
        }

        function viewApplicationDetails(appId) {
            // Could navigate to detailed view in future
            showToast('View application details (feature coming soon)', 'info');
        }

        function showToast(message, type = 'info') {
            // Simple toast notification
            const bg = type === 'success' ? 'bg-emerald-500/20 text-emerald-400' : 
                       type === 'error' ? 'bg-red-500/20 text-red-400' : 
                       'bg-blue-500/20 text-blue-400';
            const toast = document.createElement('div');
            toast.className = `fixed bottom-4 right-4 px-4 py-2 ${bg} rounded-lg text-sm z-50`;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        function showModal() {
            document.getElementById('createStartupModal').classList.remove('hidden');
        }

        function closeStartupModal() {
            document.getElementById('createStartupModal').classList.add('hidden');
        }

        document.getElementById('createStartupForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            try {
                const formData = {
                    name: document.getElementById('startupName').value,
                    description: document.getElementById('startupDesc').value,
                    industry: document.getElementById('startupIndustry').value
                };

                const response = await fetch('/api/v1/startups/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${window.CollabHubAPI.getAccessToken()}`
                    },
                    body: JSON.stringify(formData)
                });

                if (response.ok) {
                    closeStartupModal();
                    showToast('Startup created successfully!', 'success');
                    document.getElementById('createStartupForm').reset();
                    loadDashboardData();
                } else {
                    const error = await response.json();
                    showToast('Error creating startup: ' + (error.detail || 'Please try again'), 'error');
                }
            } catch (error) {
                console.error('Error creating startup:', error);
                showToast('An error occurred. Please try again.', 'error');
            }
        });

        // Initialize dashboard
        loadDashboardData();
        setInterval(loadDashboardData, 30000); // Refresh every 30 seconds

        async function handleLogout() { 
            await window.CollabHubAPI.api.logout();
            window.location.href = '/app/login';
        }
    </script>
</body>

</html>