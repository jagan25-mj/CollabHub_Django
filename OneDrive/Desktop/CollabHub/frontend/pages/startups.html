<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Explore Startups - CollabHub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../css/styles.css">
</head>
<body class="bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900 min-h-screen font-sans">
    <!-- Navigation -->
    <nav class="fixed w-full z-50 bg-slate-900/80 backdrop-blur-xl border-b border-white/10">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16 items-center">
                <!-- Logo -->
                <a href="/" class="flex items-center space-x-2">
                    <div class="w-10 h-10 bg-gradient-to-r from-primary-500 to-secondary-500 rounded-xl flex items-center justify-center">
                        <span class="text-white font-bold text-xl">C</span>
                    </div>
                    <span class="text-white font-bold text-xl">CollabHub</span>
                </a>

                <!-- Unauthenticated Navigation -->
                <div id="unauthenticated-nav" class="hidden md:flex items-center space-x-8">
                </div>

                <!-- Authenticated Navigation -->
                <div id="authenticated-nav" class="hidden md:flex items-center space-x-8">
                    <a href="/" class="text-gray-300 hover:text-white transition-colors">Home</a>
                    <a href="/app/startups" class="text-primary-400 hover:text-primary-300 transition-colors">Explore Startups</a>
                    <a href="/app/network" class="text-gray-300 hover:text-white transition-colors">Network</a>
                    <a href="#" id="dashboard-link" class="text-gray-300 hover:text-white transition-colors">Dashboard</a>
                    <a href="/app/messages" class="text-gray-300 hover:text-white transition-colors">Messages</a>
                </div>

                <!-- Unauthenticated Actions -->
                <div id="unauthenticated-actions" class="flex items-center space-x-4">
                    <a href="/app/login" class="text-gray-300 hover:text-white transition-colors">Sign In</a>
                    <a href="/app/register" class="px-4 py-2 bg-gradient-to-r from-primary-500 to-secondary-500 text-white rounded-lg font-medium hover:opacity-90">Get Started</a>
                </div>

                <!-- Authenticated Actions -->
                <div id="authenticated-actions" class="hidden items-center space-x-4">
                    <a href="/app/profile" class="text-gray-300 hover:text-white transition-colors">Profile</a>
                    <button id="logout-btn" class="text-red-400 hover:text-red-300 transition-colors">Logout</button>
                </div>
            </div>
        </div>
    </nav>

    <main class="pt-24 pb-12 px-4">
        <div class="max-w-7xl mx-auto">
            <div class="mb-12">
                <h1 class="text-4xl font-bold text-white mb-2">Explore Startups</h1>
                <p class="text-gray-400 text-lg">Discover innovative startups and connect with founders</p>
            </div>

            <!-- Filters -->
            <div class="bg-white/5 backdrop-blur-xl rounded-2xl p-6 border border-white/10 mb-8">
                <div class="grid md:grid-cols-4 gap-4">
                    <!-- Search with Autocomplete -->
                    <div class="relative">
                        <label class="block text-sm text-gray-400 mb-2">Search</label>
                        <input id="search-input" type="text" placeholder="Startup name, keyword..." 
                            class="w-full px-3 py-2 bg-white/10 text-white rounded-lg border border-white/20 focus:border-primary-500 focus:outline-none" 
                            autocomplete="off">
                        <!-- Autocomplete Dropdown -->
                        <div id="search-suggestions" class="hidden absolute top-full left-0 right-0 mt-1 bg-slate-800 border border-white/20 rounded-lg shadow-xl max-h-48 overflow-y-auto z-10">
                            <div class="p-2 space-y-1" id="suggestions-list"></div>
                        </div>
                    </div>

                    <!-- Industry Filter -->
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">Industry</label>
                        <select id="industry-filter" class="w-full px-3 py-2 bg-white/10 text-white rounded-lg border border-white/20 focus:border-primary-500 focus:outline-none">
                            <option value="">All Industries</option>
                            <option value="AI/ML">AI/ML</option>
                            <option value="FinTech">FinTech</option>
                            <option value="SaaS">SaaS</option>
                            <option value="Web3">Web3</option>
                            <option value="HealthTech">HealthTech</option>
                            <option value="EdTech">EdTech</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>

                    <!-- Stage Filter -->
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">Stage</label>
                        <select id="stage-filter" class="w-full px-3 py-2 bg-white/10 text-white rounded-lg border border-white/20 focus:border-primary-500 focus:outline-none">
                            <option value="">All Stages</option>
                            <option value="idea">Idea</option>
                            <option value="mvp">MVP</option>
                            <option value="early">Early</option>
                            <option value="growth">Growth</option>
                            <option value="scale">Scale</option>
                        </select>
                    </div>

                    <!-- Location Filter -->
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">Location</label>
                        <select id="remote-filter" class="w-full px-3 py-2 bg-white/10 text-white rounded-lg border border-white/20 focus:border-primary-500 focus:outline-none">
                            <option value="">All Locations</option>
                            <option value="true">Remote</option>
                            <option value="false">On-site</option>
                        </select>
                    </div>
                </div>

                <!-- Advanced Filters & Saved Searches -->
                <div class="mt-4 pt-4 border-t border-white/10 flex items-center justify-between">
                    <button id="clear-filters" class="px-3 py-1 text-sm text-gray-400 hover:text-white transition-colors">Clear Filters</button>
                    <div class="flex gap-2 items-center">
                        <button id="save-search-btn" class="px-3 py-1 text-sm bg-primary-500/20 text-primary-400 hover:bg-primary-500/30 rounded transition-colors">
                            üíæ Save Search
                        </button>
                        <div class="relative">
                            <button id="saved-searches-btn" class="px-3 py-1 text-sm bg-white/10 text-gray-300 hover:bg-white/20 rounded transition-colors">
                                üìå Saved (0)
                            </button>
                            <!-- Saved Searches Dropdown -->
                            <div id="saved-searches-dropdown" class="hidden absolute right-0 mt-1 w-64 bg-slate-800 border border-white/20 rounded-lg shadow-xl max-h-64 overflow-y-auto z-10">
                                <div class="p-3 border-b border-white/10">
                                    <h3 class="text-white text-sm font-semibold">Saved Searches</h3>
                                </div>
                                <div id="saved-searches-list" class="p-2 space-y-1">
                                    <p class="text-gray-500 text-xs p-2">No saved searches yet</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Startups Grid -->
            <div id="startups-list" class="grid md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                <!-- Populated by JS -->
            </div>

            <!-- Empty State -->
            <div id="empty-state" class="hidden text-center py-12">
                <p class="text-gray-400 text-lg">No startups found matching your criteria</p>
            </div>

            <!-- Pagination -->
            <div class="flex justify-center gap-4 mt-12">
                <button id="prev-btn" class="px-4 py-2 bg-white/10 text-white rounded-lg hover:bg-white/20 transition-colors">‚Üê Previous</button>
                <span id="page-info" class="text-gray-400 py-2">Page 1</span>
                <button id="next-btn" class="px-4 py-2 bg-white/10 text-white rounded-lg hover:bg-white/20 transition-colors">Next ‚Üí</button>
            </div>
        </div>
    </main>

    <script src="../js/api.js"></script>
    <script src="../js/app.js"></script>
    <script>
        // Check authentication
        if (!window.CollabHubAPI.isAuthenticated()) {
            window.location.href = '/app/login';
        }

        let currentPage = 1;
        const pageSize = 12;
        let allStartups = [];
        let filteredStartups = [];
        let savedSearches = [];
        let searchHistory = [];

        // Filter event listeners
        document.getElementById('search-input').addEventListener('input', debounce((e) => {
            handleSearchInput(e);
        }, 300));
        document.getElementById('industry-filter').addEventListener('change', applyFilters);
        document.getElementById('stage-filter').addEventListener('change', applyFilters);
        document.getElementById('remote-filter').addEventListener('change', applyFilters);
        document.getElementById('prev-btn').addEventListener('click', () => changePage(-1));
        document.getElementById('next-btn').addEventListener('click', () => changePage(1));
        document.getElementById('clear-filters').addEventListener('click', clearAllFilters);
        document.getElementById('save-search-btn').addEventListener('click', saveCurrentSearch);
        document.getElementById('saved-searches-btn').addEventListener('click', toggleSavedSearches);

        // Close suggestions when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('#search-input') && !e.target.closest('#search-suggestions')) {
                document.getElementById('search-suggestions').classList.add('hidden');
            }
            if (!e.target.closest('#saved-searches-btn') && !e.target.closest('#saved-searches-dropdown')) {
                document.getElementById('saved-searches-dropdown').classList.add('hidden');
            }
        });

        // Load saved searches from localStorage
        function loadSavedSearches() {
            savedSearches = JSON.parse(localStorage.getItem('saved_searches') || '[]');
            searchHistory = JSON.parse(localStorage.getItem('search_history') || '[]');
            updateSavedSearchesUI();
        }

        // Handle search input with autocomplete
        function handleSearchInput(e) {
            const query = e.target.value.toLowerCase();
            
            // Show suggestions
            if (query.length > 0) {
                const suggestions = allStartups
                    .filter(s => s.name.toLowerCase().includes(query) || s.tagline?.toLowerCase().includes(query))
                    .slice(0, 5);
                
                const suggestionsList = document.getElementById('suggestions-list');
                if (suggestions.length > 0) {
                    suggestionsList.innerHTML = suggestions.map(s => `
                        <button type="button" class="w-full text-left px-3 py-2 text-gray-300 hover:bg-white/10 rounded text-sm" 
                            onclick="selectSuggestion('${s.name.replace(/'/g, "\\'")}')">
                            <p class="font-medium">${s.name}</p>
                            <p class="text-xs text-gray-500">${s.industry} ‚Ä¢ ${s.stage}</p>
                        </button>
                    `).join('');
                    document.getElementById('search-suggestions').classList.remove('hidden');
                } else {
                    suggestionsList.innerHTML = '<p class="text-gray-500 text-xs p-2">No startups found</p>';
                    document.getElementById('search-suggestions').classList.remove('hidden');
                }
            } else {
                document.getElementById('search-suggestions').classList.add('hidden');
            }

            // Apply filters after debounce
            applyFilters();
        }

        function selectSuggestion(name) {
            document.getElementById('search-input').value = name;
            document.getElementById('search-suggestions').classList.add('hidden');
            applyFilters();
            addToSearchHistory(name);
        }

        function addToSearchHistory(query) {
            if (query && !searchHistory.includes(query)) {
                searchHistory.unshift(query);
                searchHistory = searchHistory.slice(0, 10); // Keep last 10
                localStorage.setItem('search_history', JSON.stringify(searchHistory));
            }
        }

        function clearAllFilters() {
            document.getElementById('search-input').value = '';
            document.getElementById('industry-filter').value = '';
            document.getElementById('stage-filter').value = '';
            document.getElementById('remote-filter').value = '';
            applyFilters();
            showToast('Filters cleared', 'success');
        }

        function saveCurrentSearch() {
            const search = {
                query: document.getElementById('search-input').value,
                industry: document.getElementById('industry-filter').value,
                stage: document.getElementById('stage-filter').value,
                remote: document.getElementById('remote-filter').value,
                timestamp: new Date().toISOString(),
                count: filteredStartups.length
            };

            // Check if search already exists
            const exists = savedSearches.find(s => 
                s.query === search.query && 
                s.industry === search.industry && 
                s.stage === search.stage && 
                s.remote === search.remote
            );

            if (exists) {
                showToast('This search is already saved', 'info');
                return;
            }

            savedSearches.unshift(search);
            savedSearches = savedSearches.slice(0, 20); // Keep last 20
            localStorage.setItem('saved_searches', JSON.stringify(savedSearches));
            updateSavedSearchesUI();
            showToast('Search saved!', 'success');
        }

        function updateSavedSearchesUI() {
            const btn = document.getElementById('saved-searches-btn');
            btn.textContent = `üìå Saved (${savedSearches.length})`;

            const list = document.getElementById('saved-searches-list');
            if (savedSearches.length === 0) {
                list.innerHTML = '<p class="text-gray-500 text-xs p-2">No saved searches yet</p>';
            } else {
                list.innerHTML = savedSearches.map((s, i) => `
                    <div class="p-2 bg-white/5 rounded text-sm">
                        <button type="button" class="w-full text-left text-gray-300 hover:text-white transition-colors"
                            onclick="applySavedSearch(${i})">
                            <p class="font-medium truncate">${s.query || 'All Startups'}</p>
                            <p class="text-xs text-gray-500">${s.count} results ‚Ä¢ ${s.industry || 'All'} ‚Ä¢ ${s.stage || 'All'}</p>
                        </button>
                        <button type="button" class="mt-1 w-full px-2 py-1 text-xs text-red-400 hover:text-red-300 hover:bg-red-500/10 rounded"
                            onclick="deleteSavedSearch(${i})">
                            Delete
                        </button>
                    </div>
                `).join('');
            }
        }

        function applySavedSearch(index) {
            const search = savedSearches[index];
            document.getElementById('search-input').value = search.query || '';
            document.getElementById('industry-filter').value = search.industry || '';
            document.getElementById('stage-filter').value = search.stage || '';
            document.getElementById('remote-filter').value = search.remote || '';
            document.getElementById('saved-searches-dropdown').classList.add('hidden');
            applyFilters();
        }

        function deleteSavedSearch(index) {
            savedSearches.splice(index, 1);
            localStorage.setItem('saved_searches', JSON.stringify(savedSearches));
            updateSavedSearchesUI();
            showToast('Search removed', 'success');
        }

        function toggleSavedSearches() {
            document.getElementById('saved-searches-dropdown').classList.toggle('hidden');
        }

        async function loadStartups() {
            try {
                let url = '/api/v1/startups/?limit=1000';
                const res = await fetch(url, {
                    headers: { 'Authorization': `Bearer ${window.CollabHubAPI.getAccessToken()}` }
                });
                const data = await res.json();
                allStartups = Array.isArray(data) ? data : (data.results || []);
                applyFilters();
                loadSavedSearches();
            } catch (error) {
                console.error('Error loading startups:', error);
            }
        }

        function applyFilters() {
            const search = document.getElementById('search-input').value.toLowerCase();
            const industry = document.getElementById('industry-filter').value;
            const stage = document.getElementById('stage-filter').value;
            const isRemote = document.getElementById('remote-filter').value;

            filteredStartups = allStartups.filter(startup => {
                const matchesSearch = !search || 
                    startup.name.toLowerCase().includes(search) ||
                    startup.description.toLowerCase().includes(search) ||
                    startup.tagline?.toLowerCase().includes(search) ||
                    startup.industry.toLowerCase().includes(search);

                const matchesIndustry = !industry || startup.industry === industry;
                const matchesStage = !stage || startup.stage === stage;
                const matchesRemote = isRemote === '' || (isRemote === 'true' ? startup.is_remote : !startup.is_remote);

                return matchesSearch && matchesIndustry && matchesStage && matchesRemote;
            });

            currentPage = 1;
            renderStartups();
        }

        function renderStartups() {
            const start = (currentPage - 1) * pageSize;
            const end = start + pageSize;
            const pageStartups = filteredStartups.slice(start, end);
            const container = document.getElementById('startups-list');
            const emptyState = document.getElementById('empty-state');

            if (pageStartups.length === 0) {
                container.innerHTML = '';
                emptyState.classList.remove('hidden');
                updatePagination();
                return;
            }

            emptyState.classList.add('hidden');
            container.innerHTML = pageStartups.map(startup => `
                <div class="bg-white/5 rounded-2xl border border-white/10 overflow-hidden hover:border-primary-500/50 transition-all cursor-pointer group" onclick="viewStartup(${startup.id})">
                    <div class="p-6">
                        <div class="flex items-start justify-between mb-4">
                            <div class="w-12 h-12 bg-gradient-to-r from-primary-500 to-secondary-500 rounded-lg flex items-center justify-center text-white font-bold text-lg">
                                ${(startup.name?.[0] || 'S').toUpperCase()}
                            </div>
                            <span class="px-3 py-1 bg-primary-500/20 text-primary-400 rounded text-xs font-medium">
                                ${startup.stage?.charAt(0).toUpperCase() + startup.stage?.slice(1) || 'Idea'}
                            </span>
                        </div>
                        <h3 class="text-white font-bold text-lg mb-2 group-hover:text-primary-400 transition-colors">${startup.name}</h3>
                        <p class="text-gray-400 text-sm mb-4 line-clamp-2">${startup.description}</p>
                        <div class="flex flex-wrap gap-2 mb-4">
                            <span class="px-2 py-1 bg-white/10 text-gray-300 rounded text-xs">${startup.industry}</span>
                            ${startup.is_remote ? '<span class="px-2 py-1 bg-green-500/20 text-green-400 rounded text-xs">üåç Remote</span>' : ''}
                        </div>
                        <div class="flex items-center justify-between pt-4 border-t border-white/10">
                            <div class="text-sm text-gray-500">
                                üë• ${startup.team_size} members
                            </div>
                            <button class="px-3 py-1 bg-primary-500 text-white rounded text-sm hover:bg-primary-600 transition-colors font-medium">
                                View Details
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');

            updatePagination();
        }

        function updatePagination() {
            const totalPages = Math.ceil(filteredStartups.length / pageSize);
            document.getElementById('page-info').textContent = `Page ${currentPage} of ${Math.max(1, totalPages)}`;
            document.getElementById('prev-btn').disabled = currentPage === 1;
            document.getElementById('next-btn').disabled = currentPage === totalPages || totalPages === 0;
        }

        function changePage(direction) {
            const totalPages = Math.ceil(filteredStartups.length / pageSize);
            const newPage = currentPage + direction;
            if (newPage >= 1 && newPage <= totalPages) {
                currentPage = newPage;
                renderStartups();
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        }

        function viewStartup(startupId) {
            window.location.href = `/app/startup-detail?id=${startupId}`;
        }

        async function handleLogout() {
            await window.CollabHubAPI.api.logout();
            window.location.href = '/app/login';
        }

        // Initialize
        loadStartups();
    </script>