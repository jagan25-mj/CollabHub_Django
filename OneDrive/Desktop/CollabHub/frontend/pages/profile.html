<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Profile - CollabHub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../css/styles.css">
</head>

<body class="bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900 min-h-screen font-sans">
    <nav class="fixed w-full z-50 bg-slate-900/95 backdrop-blur-xl border-b border-white/10">
        <div class="max-w-7xl mx-auto px-4 flex justify-between h-16 items-center">
            <a href="/" class="flex items-center space-x-2">
                <div
                    class="w-10 h-10 bg-gradient-to-r from-sky-500 to-fuchsia-500 rounded-xl flex items-center justify-center">
                    <span class="text-white font-bold">C</span>
                </div>
                <span class="text-white font-bold text-xl">CollabHub</span>
            </a>
            <div class="flex items-center space-x-4">
                <button onclick="handleLogout()" class="text-red-400 hover:text-red-300">Logout</button>
            </div>
        </div>
    </nav>

    <main class="pt-24 pb-12 px-4">
        <div class="max-w-4xl mx-auto">
            <!-- Profile Header -->
            <div class="bg-white/5 rounded-2xl border border-white/10 overflow-hidden mb-8">
                <div class="h-32 bg-gradient-to-r from-sky-500/30 via-fuchsia-500/30 to-emerald-500/30"></div>
                <div class="px-8 pb-8">
                    <div class="flex flex-col md:flex-row md:items-end -mt-16 mb-6">
                        <div class="w-32 h-32 bg-gradient-to-r from-sky-500 to-fuchsia-500 rounded-2xl flex items-center justify-center text-white text-4xl font-bold border-4 border-slate-900"
                            id="avatar">U</div>
                        <div class="mt-4 md:mt-0 md:ml-6 flex-1">
                            <h1 class="text-2xl font-bold text-white" id="profile-name">Loading...</h1>
                            <p class="text-gray-400" id="profile-role">User</p>
                        </div>
                        <button onclick="toggleEdit()"
                            class="mt-4 md:mt-0 px-5 py-2 bg-white/10 text-white rounded-lg hover:bg-white/20 transition-all">Edit
                            Profile</button>
                    </div>
                    <p class="text-gray-300 mb-4" id="profile-bio">Add a bio to tell others about yourself...</p>
                    <div class="flex flex-wrap gap-4 text-sm text-gray-400">
                        <span id="profile-location">üìç Location not set</span>
                        <span id="profile-email">‚úâÔ∏è email@example.com</span>
                    </div>
                </div>
            </div>

            <div class="grid md:grid-cols-3 gap-8">
                <!-- Main Content -->
                <div class="md:col-span-2 space-y-6">
                    <!-- Profile Completion -->
                    <div class="bg-white/5 rounded-2xl p-6 border border-white/10 mb-6">
                        <div class="flex justify-between items-center mb-3">
                            <h2 class="text-lg font-semibold text-white">Profile Completion</h2>
                            <span id="completion-percent" class="text-sm font-medium text-sky-400">0%</span>
                        </div>
                        <div class="w-full bg-white/10 rounded-full h-2">
                            <div id="completion-bar" class="bg-gradient-to-r from-sky-500 to-fuchsia-500 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                        </div>
                        <p class="text-xs text-gray-400 mt-2">Complete your profile to improve discoverability</p>
                    </div>

                    <!-- Skills -->
                    <div class="bg-white/5 rounded-2xl p-6 border border-white/10">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-lg font-semibold text-white">Skills</h2>
                            <button onclick="openSkillModal()" class="px-3 py-1 bg-sky-500/20 text-sky-400 hover:bg-sky-500/30 rounded-lg text-sm font-medium transition-colors">+ Add Skill</button>
                        </div>
                        <div id="skills-list" class="flex flex-wrap gap-2 min-h-12 items-center">
                            <p class="text-gray-400 text-sm">No skills added yet. Add your first skill!</p>
                        </div>
                    </div>

                    <!-- Experience -->
                    <div class="bg-white/5 rounded-2xl p-6 border border-white/10 mt-6">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-lg font-semibold text-white">Experience & Projects</h2>
                            <button onclick="openExperienceModal()" class="px-3 py-1 bg-sky-500/20 text-sky-400 hover:bg-sky-500/30 rounded-lg text-sm font-medium transition-colors">+ Add Experience</button>
                        </div>
                        <div id="experience-list" class="space-y-4">
                            <p class="text-gray-400 text-sm">No experience entries yet.</p>
                        </div>
                    </div>
                </div>

                <!-- Sidebar -->
                <div class="space-y-6">
                    <div class="bg-white/5 rounded-2xl p-6 border border-white/10">
                        <h3 class="text-lg font-semibold text-white mb-4">Stats</h3>
                        <div class="space-y-4">
                            <div class="flex justify-between">
                                <span class="text-gray-400">Applications</span>
                                <span class="text-white font-medium">12</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-400">Connections</span>
                                <span class="text-white font-medium">45</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-400">Profile Views</span>
                                <span class="text-white font-medium">128</span>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white/5 rounded-2xl p-6 border border-white/10">
                        <h3 class="text-lg font-semibold text-white mb-4">Links</h3>
                        <div class="space-y-2">
                            <a href="#" class="flex items-center p-2 hover:bg-white/5 rounded-lg text-gray-300">
                                <span class="mr-2">üîó</span> GitHub
                            </a>
                            <a href="#" class="flex items-center p-2 hover:bg-white/5 rounded-lg text-gray-300">
                                <span class="mr-2">üîó</span> LinkedIn
                            </a>
                            <a href="#" class="flex items-center p-2 hover:bg-white/5 rounded-lg text-gray-300">
                                <span class="mr-2">üåê</span> Portfolio
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Edit Profile Modal -->
    <div id="editModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-slate-800 rounded-2xl border border-white/10 w-full max-w-md">
            <div class="p-6 border-b border-white/10 flex justify-between items-center">
                <h2 class="text-xl font-bold text-white">Edit Profile</h2>
                <button onclick="closeEditModal()" class="text-gray-400 hover:text-white">‚úï</button>
            </div>
            <form id="editProfileForm" class="p-6 space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">First Name</label>
                        <input id="firstName" type="text" placeholder="First Name" class="w-full px-3 py-2 bg-white/10 text-white rounded-lg border border-white/20 focus:border-sky-500 focus:outline-none">
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">Last Name</label>
                        <input id="lastName" type="text" placeholder="Last Name" class="w-full px-3 py-2 bg-white/10 text-white rounded-lg border border-white/20 focus:border-sky-500 focus:outline-none">
                    </div>
                </div>
                <div>
                    <label class="block text-sm text-gray-400 mb-2">Bio</label>
                    <textarea id="bio" placeholder="Tell us about yourself..." class="w-full px-3 py-2 bg-white/10 text-white rounded-lg border border-white/20 focus:border-sky-500 focus:outline-none" rows="3"></textarea>
                </div>
                <div>
                    <label class="block text-sm text-gray-400 mb-2">Location</label>
                    <input id="location" type="text" placeholder="City, Country" class="w-full px-3 py-2 bg-white/10 text-white rounded-lg border border-white/20 focus:border-sky-500 focus:outline-none">
                </div>
                <div class="flex gap-3 pt-4">
                    <button type="submit" class="flex-1 px-4 py-2 bg-gradient-to-r from-sky-500 to-fuchsia-500 text-white rounded-lg font-medium hover:opacity-90">Save Changes</button>
                    <button type="button" onclick="closeEditModal()" class="flex-1 px-4 py-2 bg-white/10 text-white rounded-lg hover:bg-white/20">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Skill Modal -->
    <div id="skillModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-slate-800 rounded-2xl border border-white/10 w-full max-w-md">
            <div class="p-6 border-b border-white/10 flex justify-between items-center">
                <h2 class="text-xl font-bold text-white">Add Skill</h2>
                <button onclick="closeSkillModal()" class="text-gray-400 hover:text-white">‚úï</button>
            </div>
            <form id="skillForm" class="p-6 space-y-4">
                <div>
                    <label class="block text-sm text-gray-400 mb-2">Skill Name</label>
                    <input id="skillSearch" type="text" placeholder="Search or type skill..." 
                        class="w-full px-3 py-2 bg-white/10 text-white rounded-lg border border-white/20 focus:border-sky-500 focus:outline-none"
                        autocomplete="off">
                    <div id="skill-suggestions" class="mt-2 max-h-40 overflow-y-auto space-y-1 hidden">
                        <!-- Populated by JS -->
                    </div>
                </div>
                <div>
                    <label class="block text-sm text-gray-400 mb-2">Proficiency Level</label>
                    <select id="proficiency" class="w-full px-3 py-2 bg-white/10 text-white rounded-lg border border-white/20 focus:border-sky-500 focus:outline-none">
                        <option value="beginner">Beginner</option>
                        <option value="intermediate" selected>Intermediate</option>
                        <option value="advanced">Advanced</option>
                        <option value="expert">Expert</option>
                    </select>
                </div>
                <div class="flex gap-3 pt-4">
                    <button type="submit" class="flex-1 px-4 py-2 bg-sky-500 text-white rounded-lg font-medium hover:bg-sky-600">Add Skill</button>
                    <button type="button" onclick="closeSkillModal()" class="flex-1 px-4 py-2 bg-white/10 text-white rounded-lg hover:bg-white/20">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Experience Modal -->
    <div id="experienceModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 overflow-y-auto">
        <div class="bg-slate-800 rounded-2xl border border-white/10 w-full max-w-md my-8">
            <div class="p-6 border-b border-white/10 flex justify-between items-center">
                <h2 class="text-xl font-bold text-white">Add Experience</h2>
                <button onclick="closeExperienceModal()" class="text-gray-400 hover:text-white">‚úï</button>
            </div>
            <form id="experienceForm" class="p-6 space-y-4">
                <div>
                    <label class="block text-sm text-gray-400 mb-2">Title</label>
                    <input id="exp-title" type="text" placeholder="e.g., Senior Developer" 
                        class="w-full px-3 py-2 bg-white/10 text-white rounded-lg border border-white/20 focus:border-sky-500 focus:outline-none" required>
                </div>
                <div>
                    <label class="block text-sm text-gray-400 mb-2">Company</label>
                    <input id="exp-company" type="text" placeholder="e.g., Tech Startup Inc." 
                        class="w-full px-3 py-2 bg-white/10 text-white rounded-lg border border-white/20 focus:border-sky-500 focus:outline-none" required>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">Start Date</label>
                        <input id="exp-start" type="month" 
                            class="w-full px-3 py-2 bg-white/10 text-white rounded-lg border border-white/20 focus:border-sky-500 focus:outline-none" required>
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">End Date</label>
                        <input id="exp-end" type="month" 
                            class="w-full px-3 py-2 bg-white/10 text-white rounded-lg border border-white/20 focus:border-sky-500 focus:outline-none">
                    </div>
                </div>
                <div class="flex items-center">
                    <input id="exp-current" type="checkbox" class="w-4 h-4 bg-white/10 rounded border-white/20 cursor-pointer">
                    <label for="exp-current" class="ml-2 text-sm text-gray-400 cursor-pointer">I currently work here</label>
                </div>
                <div>
                    <label class="block text-sm text-gray-400 mb-2">Description</label>
                    <textarea id="exp-description" placeholder="Describe your role and achievements..." 
                        class="w-full px-3 py-2 bg-white/10 text-white rounded-lg border border-white/20 focus:border-sky-500 focus:outline-none" rows="3"></textarea>
                </div>
                <div class="flex gap-3 pt-4">
                    <button type="submit" class="flex-1 px-4 py-2 bg-sky-500 text-white rounded-lg font-medium hover:bg-sky-600">Add Experience</button>
                    <button type="button" onclick="closeExperienceModal()" class="flex-1 px-4 py-2 bg-white/10 text-white rounded-lg hover:bg-white/20">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <script src="../js/api.js"></script>
    <script src="../js/app.js"></script>
    <script>
        if (!window.CollabHubAPI.isAuthenticated()) window.location.href = '/app/login';

        const user = window.CollabHubAPI.getUserData();
        let allSkills = [];
        let userSkills = [];
        let userExperiences = [];

        // Initialize profile
        async function initProfile() {
            if (user) {
                document.getElementById('avatar').textContent = (user.first_name?.[0] || 'U').toUpperCase();
                document.getElementById('profile-name').textContent = `${user.first_name || ''} ${user.last_name || ''}`.trim() || user.username;
                document.getElementById('profile-role').textContent = user.role?.charAt(0).toUpperCase() + user.role?.slice(1) || 'User';
                document.getElementById('profile-email').textContent = '‚úâÔ∏è ' + user.email;
                document.getElementById('profile-bio').textContent = user.bio || 'Add a bio to tell others about yourself...';
                document.getElementById('profile-location').textContent = user.location ? 'üìç ' + user.location : 'üìç Location not set';
            }

            // Load skills and experiences
            await loadSkills();
            await loadExperiences();
            calculateProfileCompletion();
        }

        // Load all available skills
        async function loadSkills() {
            try {
                const res = await fetch('/api/v1/users/skills/', {
                    headers: { 'Authorization': `Bearer ${window.CollabHubAPI.getAccessToken()}` }
                });
                const data = await res.json();
                allSkills = Array.isArray(data) ? data : (data.results || []);

                // Load user's skills
                const userRes = await fetch('/api/v1/users/me/skills/', {
                    headers: { 'Authorization': `Bearer ${window.CollabHubAPI.getAccessToken()}` }
                });
                const userData = await userRes.json();
                userSkills = Array.isArray(userData) ? userData : (userData.results || []);

                renderSkills();
            } catch (error) {
                console.error('Error loading skills:', error);
            }
        }

        // Load user's experiences
        async function loadExperiences() {
            try {
                const res = await fetch('/api/v1/users/me/', {
                    headers: { 'Authorization': `Bearer ${window.CollabHubAPI.getAccessToken()}` }
                });
                const userData = await res.json();
                userExperiences = userData.experiences || [];
                renderExperiences();
            } catch (error) {
                console.error('Error loading experiences:', error);
            }
        }

        // Render skills
        function renderSkills() {
            const container = document.getElementById('skills-list');

            if (userSkills.length === 0) {
                container.innerHTML = '<p class="text-gray-400 text-sm">No skills added yet. Add your first skill!</p>';
                return;
            }

            container.innerHTML = userSkills.map(skill => `
                <div class="group relative">
                    <span class="px-3 py-1 bg-sky-500/20 text-sky-400 rounded-full text-sm flex items-center gap-2">
                        ${skill.name}
                        <span class="text-xs text-sky-300">${skill.proficiency}</span>
                        <button type="button" onclick="removeSkill(${skill.id})" class="opacity-0 group-hover:opacity-100 transition-opacity">
                            ‚úï
                        </button>
                    </span>
                </div>
            `).join('');
        }

        // Render experiences
        function renderExperiences() {
            const container = document.getElementById('experience-list');

            if (userExperiences.length === 0) {
                container.innerHTML = '<p class="text-gray-400 text-sm">No experience entries yet.</p>';
                return;
            }

            container.innerHTML = userExperiences.map(exp => `
                <div class="p-4 bg-white/5 rounded-xl border border-white/10 group hover:border-white/20 transition-colors">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <h3 class="text-white font-medium">${exp.title}</h3>
                            <p class="text-gray-400 text-sm">${exp.company}${exp.is_current ? ' ‚Ä¢ Current' : ''}</p>
                            <p class="text-gray-500 text-xs mt-1">${formatDate(exp.start_date)} - ${exp.is_current ? 'Present' : formatDate(exp.end_date)}</p>
                            ${exp.description ? `<p class="text-gray-300 text-sm mt-2">${exp.description}</p>` : ''}
                        </div>
                        <button onclick="removeExperience(${exp.id})" class="opacity-0 group-hover:opacity-100 text-red-400 hover:text-red-300 transition-opacity">
                            ‚úï
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // Skill modal functions
        function openSkillModal() {
            document.getElementById('skillModal').classList.remove('hidden');
        }

        function closeSkillModal() {
            document.getElementById('skillModal').classList.add('hidden');
            document.getElementById('skillForm').reset();
            document.getElementById('skill-suggestions').classList.add('hidden');
        }

        // Skill search autocomplete
        document.getElementById('skillSearch').addEventListener('input', debounce((e) => {
            const query = e.target.value.toLowerCase();
            if (query.length < 1) {
                document.getElementById('skill-suggestions').classList.add('hidden');
                return;
            }

            const suggestions = allSkills.filter(s => 
                s.name.toLowerCase().includes(query) &&
                !userSkills.find(us => us.id === s.id)
            ).slice(0, 5);

            const container = document.getElementById('skill-suggestions');
            if (suggestions.length === 0) {
                container.innerHTML = '<p class="text-gray-400 text-xs p-2">No suggestions found</p>';
            } else {
                container.innerHTML = suggestions.map(s => `
                    <div onclick="selectSkill('${s.id}', '${s.name}')" class="p-2 hover:bg-white/10 rounded cursor-pointer text-gray-300 text-sm">
                        ${s.name}
                    </div>
                `).join('');
            }
            container.classList.remove('hidden');
        }, 300));

        function selectSkill(skillId, skillName) {
            document.getElementById('skillSearch').value = skillName;
            document.getElementById('skill-suggestions').classList.add('hidden');
        }

        // Add skill
        document.getElementById('skillForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const skillName = document.getElementById('skillSearch').value.trim();
            const proficiency = document.getElementById('proficiency').value;

            if (!skillName) {
                showToast('Please enter a skill name', 'error');
                return;
            }

            try {
                const skill = allSkills.find(s => s.name.toLowerCase() === skillName.toLowerCase());
                const skillId = skill ? skill.id : null;

                const res = await fetch('/api/v1/users/me/skills/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${window.CollabHubAPI.getAccessToken()}`
                    },
                    body: JSON.stringify({
                        skill: skillId,
                        name: skillName,
                        proficiency: proficiency
                    })
                });

                if (res.ok) {
                    await loadSkills();
                    closeSkillModal();
                    showToast('Skill added successfully', 'success');
                    calculateProfileCompletion();
                } else {
                    showToast('Error adding skill', 'error');
                }
            } catch (error) {
                console.error('Error adding skill:', error);
                showToast('Error adding skill', 'error');
            }
        });

        // Remove skill
        async function removeSkill(skillId) {
            try {
                const res = await fetch(`/api/v1/users/me/skills/${skillId}/`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${window.CollabHubAPI.getAccessToken()}` }
                });

                if (res.ok) {
                    await loadSkills();
                    showToast('Skill removed', 'success');
                    calculateProfileCompletion();
                }
            } catch (error) {
                console.error('Error removing skill:', error);
                showToast('Error removing skill', 'error');
            }
        }

        // Experience modal functions
        function openExperienceModal() {
            document.getElementById('experienceModal').classList.remove('hidden');
        }

        function closeExperienceModal() {
            document.getElementById('experienceModal').classList.add('hidden');
            document.getElementById('experienceForm').reset();
        }

        // Handle current job checkbox
        document.getElementById('exp-current').addEventListener('change', (e) => {
            document.getElementById('exp-end').disabled = e.target.checked;
        });

        // Add experience
        document.getElementById('experienceForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const title = document.getElementById('exp-title').value.trim();
            const company = document.getElementById('exp-company').value.trim();
            const startDate = document.getElementById('exp-start').value;
            const endDate = document.getElementById('exp-end').value;
            const isCurrent = document.getElementById('exp-current').checked;
            const description = document.getElementById('exp-description').value.trim();

            if (!title || !company || !startDate) {
                showToast('Please fill in all required fields', 'error');
                return;
            }

            try {
                const res = await fetch('/api/v1/users/me/', {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${window.CollabHubAPI.getAccessToken()}`
                    },
                    body: JSON.stringify({
                        experiences: [
                            ...userExperiences,
                            {
                                title,
                                company,
                                start_date: startDate,
                                end_date: isCurrent ? null : endDate,
                                is_current: isCurrent,
                                description
                            }
                        ]
                    })
                });

                if (res.ok) {
                    await loadExperiences();
                    closeExperienceModal();
                    showToast('Experience added successfully', 'success');
                    calculateProfileCompletion();
                } else {
                    showToast('Error adding experience', 'error');
                }
            } catch (error) {
                console.error('Error adding experience:', error);
                showToast('Error adding experience', 'error');
            }
        });

        // Remove experience
        async function removeExperience(index) {
            userExperiences.splice(index, 1);
            try {
                const res = await fetch('/api/v1/users/me/', {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${window.CollabHubAPI.getAccessToken()}`
                    },
                    body: JSON.stringify({ experiences: userExperiences })
                });

                if (res.ok) {
                    await loadExperiences();
                    showToast('Experience removed', 'success');
                    calculateProfileCompletion();
                }
            } catch (error) {
                console.error('Error removing experience:', error);
                showToast('Error removing experience', 'error');
            }
        }

        // Calculate profile completion
        function calculateProfileCompletion() {
            let completed = 0;
            const total = 5;

            if (user?.first_name && user?.last_name) completed++;
            if (user?.bio && user.bio.length > 20) completed++;
            if (user?.location) completed++;
            if (userSkills.length > 0) completed++;
            if (userExperiences.length > 0) completed++;

            const percent = Math.round((completed / total) * 100);
            document.getElementById('completion-percent').textContent = `${percent}%`;
            document.getElementById('completion-bar').style.width = `${percent}%`;
        }

        function formatDate(dateString) {
            if (!dateString) return 'Unknown';
            const date = new Date(dateString + '-01');
            return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short' });
        }

        function toggleEdit() {
            if (user) {
                document.getElementById('firstName').value = user.first_name || '';
                document.getElementById('lastName').value = user.last_name || '';
                document.getElementById('bio').value = user.bio || '';
                document.getElementById('location').value = user.location || '';
            }
            document.getElementById('editModal').classList.remove('hidden');
        }

        function closeEditModal() {
            document.getElementById('editModal').classList.add('hidden');
        }

        document.getElementById('editProfileForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            try {
                const formData = {
                    first_name: document.getElementById('firstName').value,
                    last_name: document.getElementById('lastName').value,
                    bio: document.getElementById('bio').value,
                    location: document.getElementById('location').value
                };

                const response = await fetch('/api/v1/users/me/', {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${window.CollabHubAPI.getAccessToken()}`
                    },
                    body: JSON.stringify(formData)
                });

                if (response.ok) {
                    const updatedUser = await response.json();
                    window.localStorage.setItem('user_data', JSON.stringify(updatedUser));
                    Object.assign(user, updatedUser);
                    closeEditModal();
                    initProfile();
                    showToast('Profile updated successfully', 'success');
                } else {
                    showToast('Failed to update profile', 'error');
                }
            } catch (error) {
                console.error('Error updating profile:', error);
                showToast('An error occurred', 'error');
            }
        });

        async function handleLogout() {
            await window.CollabHubAPI.api.logout();
            window.location.href = '/app/login';
        }

        // Initialize on load
        initProfile();
    </script>
</body>

</html>